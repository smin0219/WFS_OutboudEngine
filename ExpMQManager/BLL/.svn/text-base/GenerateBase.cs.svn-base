using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using ExpMQManager.DAL;
using ExpMQManager.Data;

namespace ExpMQManager.BLL
{
    public abstract class GenerateBase : BaseDAC
    {
        public abstract string doBuildUp(string msgType, string subType, int mid, int flightSeq, int queueId);

        public string buildUpBase(BaseEntity msgEntity, string msgType, string subType)
        {
            string strbaseAWB = "";

            #region build Message Header

            DateTime currentGMT = DateTime.UtcNow;
            string originAddr = "JFKCDCR";  //SASCSXH
            string curTime = currentGMT.ToString("dd") + currentGMT.ToString("HH") + currentGMT.ToString("mm");
            string priority = "QD";

            if (msgEntity.msgDestAddr == "")
                throw new Exception("No Message recipient is present msg QueueID: " + msgEntity.queueId);

            //Build TypeB Destination Address
            string destAddrOut = "";
            string[] destAddr = msgEntity.msgDestAddr.ToUpper().Split(' ');
            foreach (string addr in destAddr)
            {
                //Filter-out Email Address
                if (addr != "") 
                {
                    if (addr.IndexOf('@') == -1)
                    {
                        //Adding SITA TYPE-B Address
                        if (destAddrOut != "")
                            destAddrOut += " ";
                        destAddrOut += addr.Replace(",","");
                    }
                    else
                    {
                        //Email Address
                        if (msgEntity.msgDestAddrEmail != "")
                            msgEntity.msgDestAddrEmail += ";";
                        msgEntity.msgDestAddrEmail += addr;
                    }
                }
            }

            strbaseAWB += "\r\n";
            strbaseAWB += priority + " " + destAddrOut + "\r\n";
            //strbaseAWB += priority + " " + "JFKCTCR" + " " + "EPICDCR" + "\r\n";    
            strbaseAWB += "." + originAddr + " " + curTime + "\r\n";

            #endregion

            if (msgType.ToUpper() == "FSU" || msgType.ToUpper() == "FWB")
            {
                #region build AWB Header

                string weightFormatted = string.Format("{0:0.0}", msgEntity.weight);

                //char shipmentCode = replaceShipmentIndicator(msgEntity.shipmentIndicator[0]);
                char shipmentCode = 'T';
                strbaseAWB += msgType.ToUpper() + "/" + msgEntity.msgVersion + "\r\n";
                strbaseAWB += msgEntity.prefix + "-" + msgEntity.awb + msgEntity.origin + msgEntity.dest + "/" +
                            shipmentCode + msgEntity.pcs + "K" + weightFormatted + "\r\n";
                #endregion
            }

            if (msgType.ToUpper() == "FFM")
            {
                #region build FFM Header

                strbaseAWB += msgType.ToUpper() + "/" + msgEntity.msgVersion + "\r\n";

                #endregion
            }

            return strbaseAWB;
        }

        public string transMonth(String tmpm)
        {
            string tmpmonth = "";

            switch (tmpm)
            {
                case "01":
                    tmpmonth = "JAN";
                    break;
                case "02":
                    tmpmonth = "FEB";
                    break;
                case "03":
                    tmpmonth = "MAR";
                    break;
                case "04":
                    tmpmonth = "APR";
                    break;
                case "05":
                    tmpmonth = "MAY";
                    break;
                case "06":
                    tmpmonth = "JUN";
                    break;
                case "07":
                    tmpmonth = "JUL";
                    break;
                case "08":
                    tmpmonth = "AUG";
                    break;
                case "09":
                    tmpmonth = "SEP";
                    break;
                case "10":
                    tmpmonth = "OCT";
                    break;
                case "11":
                    tmpmonth = "NOV";
                    break;
                case "12":
                    tmpmonth = "DEC";
                    break;
            }

            return tmpmonth;

        }

        public char replaceShipmentIndicator(char code)
        {
            char charReturn;
            switch (code)
            {
                case 'D':
                    charReturn = 'P';
                    break;
                case 'S':
                    charReturn = 'T';
                    break;
                default:
                    charReturn = code;
                    break;
            }

            return charReturn;
        }

        public string truncateString(string source, int length)
        {
            if (source.Length > length)
            {
                source = source.Substring(0, length);
            }
            return source;
        }
    }
}
